# Situation-Based Language Learning – REST API

This document describes the REST surface exposed by the Fastify backend located in `src/backend`. The API is intentionally small but opinionated: glosses and situations are the primary resources, challenges are managed as part of situations, and every response returns the shared DTOs from `src/shared`.

---

## Conventions

| Item | Details |
| --- | --- |
| Base URL | `http://localhost:3333` (configurable through `PORT`) |
| Protocols | HTTPS in production, HTTP locally |
| Content type | JSON (`application/json`) for both requests and responses |
| Auth | _None yet_ – add gateway/JWT once required |
| Error shape | `{ "error": string }` for handled errors, or `{ "error": "Validation error", "details": [...] }` for Zod validation failures |
| Timestamps | ISO 8601 strings (`createdAt`, `updatedAt`) |
| IDs | `cuid()` strings generated by Prisma |

All endpoints are versionless for now; introduce `/v1` when the contract stabilizes.

---

## Shared DTOs

Every payload reuses the shared TypeScript DTOs:

```ts
type GlossReference = {
  id: string;
  language: LanguageCode;
  content: string;
};

interface GlossDTO {
  id: string;
  content: string;
  isParaphrased: boolean;
  transcriptions: string[];
  notes: Note[];
  contains: GlossReference[];
  nearSynonyms: GlossReference[];
  nearHomophones: GlossReference[];
  translations: GlossReference[];
  clarifiesUsage: GlossReference[];
  toBeDifferentiatedFrom: GlossReference[];
}

interface SituationDTO {
  identifier: string;
  descriptions: LocalizedString[];
  imageLink?: string;
  targetLanguage: LanguageCode;
  challengesOfExpression: ChallengeOfExpression[];
  challengesOfUnderstandingText: ChallengeOfUnderstandingText[];
}

interface SituationSummaryDTO {
  identifier: string;
  descriptions: LocalizedString[];
  imageLink?: string;
  targetLanguage: LanguageCode;
  challengeCount: {
    expression: number;
    understanding: number;
  };
}
```

Resolution rules:

- Relation arrays now return lightweight `GlossReference` entries (`{ id, language, content }`) to avoid recursive loops.

---

## Health

| Method | Path | Description |
| --- | --- | --- |
| `GET` | `/health` | Returns `{ "status": "ok" }` when the server is ready. |

---

## Glosses

### List

```
GET /glosses?language=spa&content=hola
```

Query parameters (all optional):

| Param | Type | Description |
| --- | --- | --- |
| `language` | `LanguageCode` | Filter by language. Required if `content` is provided. |
| `content` | `string` | Filter by exact content. |

Response:

```json
{
  "data": [GlossDTO, ...]
}
```

### Search (fuzzy)

```
GET /glosses/search?language=spa&query=hol&limit=5
```

Helps find existing glosses while the CMS user is typing. Returns a short list of partial matches in the specified language, ordered by recent updates.

### Retrieve

```
GET /glosses/:id
```

Response is the fully resolved `GlossDTO`.

### Create

```
POST /glosses
```

Body schema (`glossWriteSchema`):

```json
{
  "language": "spa",
  "content": "¿Cómo estás?",
  "isParaphrased": false,
  "transcriptions": ["ˈkomo esˈtas"],
  "notes": [
    { "noteType": "usage", "content": "Informal greeting", "showBeforeSolution": true }
  ],
  "containsIds": ["clfj5q3d900001s8l2i9s8kdw"],
  "nearSynonymIds": [],
  "nearHomophoneIds": [],
  "translationIds": [],
  "clarifiesUsageIds": [],
  "toBeDifferentiatedFromIds": []
}
```

All relation arrays accept gloss IDs and default to `[]`. Missing IDs are ignored; unknown IDs trigger `404`.

### Update

```
PATCH /glosses/:id
```

Partial payload (`glossUpdateSchema`). Omitting a relation array leaves it unchanged; providing it replaces the entire set.

### Delete

```
DELETE /glosses/:id
```

No response body (`204`). Use the companion endpoint below to surface warnings:

```
GET /glosses/:id/references
```

Returns `{ "totalReferences": number, "breakdown": { ... } }`, counting every challenge/gloss that still points at the target gloss.

### Validation Errors

Zod returns:

```json
{
  "error": "Validation error",
  "details": [
    { "path": ["language"], "message": "Invalid enum value" }
  ]
}
```

---

## Situations

### List

```
GET /situations?identifier=greeting-basic&targetLanguage=spa&nativeLanguages=eng,deu
```

Query parameters:

| Param | Required | Description |
| --- | --- | --- |
| `identifier` | Optional | Filter by identifier. |
| `targetLanguage` | Optional | Filter by target language code (e.g., "spa", "deu"). |
| `nativeLanguages` | Optional | Comma-separated list of user's native languages (e.g., "eng,deu"). When provided, returns only ONE prompt per challenge (best matching language from the priority list, or English fallback). Gloss trees are pruned so expression challenges only surface native-language glosses (with translations locked to the target language) and understanding challenges only surface target-language glosses (with translations locked to the selected native language). |

Response: `{ "data": [SituationDTO, ...] }`.

### List Summary

```
GET /situations/summary?targetLanguage=spa&nativeLanguages=eng,deu
```

Returns lightweight situation summaries without full challenge/gloss data. Ideal for list views.

Query parameters:

| Param | Required | Description |
| --- | --- | --- |
| `identifier` | Optional | Filter by identifier. |
| `targetLanguage` | Optional | Filter by target language code (e.g., "spa", "deu"). |
| `nativeLanguages` | Optional | Comma-separated list of user's native languages (currently unused in summary endpoint, but accepted for consistency). |

Response: `{ "data": [SituationSummaryDTO, ...] }`.

### Retrieve

```
GET /situations/:id?nativeLanguages=eng,deu
```

Where `:id` is the situation identifier (e.g., `greeting-basic`), not a cuid.

Query parameters:

| Param | Required | Description |
| --- | --- | --- |
| `nativeLanguages` | Optional | Comma-separated list of user's native languages (e.g., "eng,deu"). When provided, returns only ONE prompt per challenge (best matching language from the priority list, or English fallback). Gloss trees follow the same pruning rules as the list endpoint: expression challenges expose native-language glosses with target-language translations, while understanding challenges expose target-language glosses with native-language translations. |

Response is `{ "data": SituationDTO }`.

### Create

```
POST /situations
```

Body schema (`situationWriteSchema`):

```json
{
  "identifier": "greeting-basic",
  "descriptions": [
    { "language": "eng", "content": "Basic greetings" },
    { "language": "deu", "content": "Erste Grüße" }
  ],
  "imageLink": "https://example.com/images/greeting.jpg",
  "targetLanguage": "spa",
  "challengesOfExpression": [
    {
      "identifier": "saluda-a-un-amigo",
      "prompts": [
        { "language": "eng", "content": "Greet a friend" },
        { "language": "spa", "content": "Saluda a un amigo" }
      ],
      "glossIds": ["clfj5q3d900001s8l2i9s8kdw"]
    }
  ],
  "challengesOfUnderstandingText": [
    {
      "text": "Hola, ¿cómo estás?",
      "language": "spa",
      "glossIds": ["clfj5q3d900001s8l2i9s8kdw"]
    }
  ]
}
```

Notes:

- `targetLanguage` is required and specifies the language being learned (e.g., "spa" for Spanish situations).
- `imageLink` is optional and must be a valid URL if provided.
- `descriptions` should include UI-friendly text in multiple languages to describe the situation.
- Expression challenges must include at least one English prompt; additional languages are optional.
- Challenge arrays default to `[]`; omit them to create empty situations.
- Glosses are unique per `(language, content)`. When a matching entry already exists, attach its `id` instead of creating a duplicate (`/glosses/search` helps surface candidates).

### Update

```
PATCH /situations/:id?language=spa
```

Where `:id` is the situation identifier (e.g., `greeting-basic`).

- Request body uses `situationUpdateSchema`.
- Providing `challengesOfExpression` or `challengesOfUnderstandingText` replaces all existing challenges of that type (internally a delete + recreate).
- The `language` query parameter controls the response DTO.

### Delete

```
DELETE /situations/:id
```

Where `:id` is the situation identifier (e.g., `greeting-basic`).

Also deletes associated challenges (cascade).

---

## Status Codes

| Code | When |
| --- | --- |
| `200` | Successful GET/PATCH. |
| `201` | Resource created (POST). |
| `204` | Successful delete, no body. |
| `400` | Validation failure (Zod). |
| `404` | Resource not found (invalid ID or missing relation). |
| `409` | Unique constraint violation (duplicate gloss content per language, duplicate situation identifier). |
| `500` | Unhandled server error. |

---

## Local Development Checklist

1. `npm install`
2. Copy `src/backend/.env.example` → `.env`
3. `docker compose -f src/backend/docker-compose.yml up -d`
4. `npm run prisma:migrate:dev && npm run prisma:seed`
5. `npm run backend:dev`

The frontend CMS/CRAM apps consume the DTO shapes defined here and can depend on the documented endpoints to populate their UIs.
